{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{% url 'dashboard' %}" class="text-decoration-none text-muted small mb-2 d-inline-block">
            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
        </a>
        <h2 class="fw-bold text-white mb-0">{{ asset_name }}</h2>
        <p class="text-muted mb-0">{{ symbol }}</p>
    </div>
</div>

<div class="row g-3 mb-4 row-cols-1 row-cols-md-3 row-cols-xl-5">
    {# --- Kafelki (Hardcoded tutaj, bo sÄ… specyficzne dla pojedynczego aktywa) --- #}
    <div class="col">
        <div class="card h-100 border-secondary border-opacity-25 shadow-sm">
            <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold mb-1">Current Value</div>
                <h4 class="fw-bold text-white mb-1">{{ current_value_pln }} <small class="fs-6 text-muted">PLN</small></h4>
                <div class="small fw-bold {% if total_gain_pln_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if total_gain_pln_raw > 0 %}+{% endif %}{{ total_gain_pln }} PLN (Total)
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card h-100 border-secondary border-opacity-25 shadow-sm">
            <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold mb-1">Avg. Buy Price</div>
                <h4 class="fw-bold text-white mb-1">{{ avg_price }} <small class="fs-6 text-muted">PLN</small></h4>
                <div class="small text-muted">Qty: <span class="text-white">{{ quantity }}</span></div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card h-100 border-secondary border-opacity-25 shadow-sm">
            <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold mb-1">Current Price</div>
                <h4 class="fw-bold text-white mb-1">{{ current_price }} <small class="fs-6 text-muted">PLN</small></h4>
                <div class="small fw-bold {% if day_change_pct_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if day_change_pct_raw > 0 %}+{% endif %}{{ day_change_pct }}% (1D)
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card h-100 border-secondary border-opacity-25 shadow-sm">
            <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold mb-1">My Position ROI</div>
                <h4 class="fw-bold {% if gain_percent_raw >= 0 %}text-success{% else %}text-danger{% endif %} mb-0">
                    {% if gain_percent_raw > 0 %}+{% endif %}{{ gain_percent }}%
                </h4>
                <div class="small text-muted mt-1">All time</div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card h-100 border-secondary border-opacity-25 shadow-sm bg-dark bg-opacity-50">
            <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold mb-1" id="dynamic-label">Period Change</div>
                <h4 class="fw-bold mb-0" id="dynamic-value">---</h4>
                <div class="small text-muted mt-1" id="dynamic-sub">Select range</div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-5 border-secondary border-opacity-25">
    <div class="card-header border-0 pt-4 px-4 bg-transparent d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="fw-bold text-muted text-uppercase ls-1 mb-0">Price History</h5>

        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary active" onclick="updateChartRange('SINCE_BUY')">SINCE BUY</button>
            <button type="button" class="btn btn-outline-secondary" onclick="updateChartRange('1M')">1M</button>
            <button type="button" class="btn btn-outline-secondary" onclick="updateChartRange('3M')">3M</button>
            <button type="button" class="btn btn-outline-secondary" onclick="updateChartRange('YTD')">YTD</button>
            <button type="button" class="btn btn-outline-secondary" onclick="updateChartRange('1Y')">1Y</button>
            <button type="button" class="btn btn-outline-secondary" onclick="updateChartRange('MAX')">MAX</button>
        </div>
    </div>
    <div class="card-body">
        <div class="chart-container-wide" style="height: 450px;">
            <canvas id="assetChart"></canvas>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-xl-6">
        <h4 class="mb-3 text-white fw-bold">Transaction History</h4>
        <div class="card border-secondary border-opacity-25 h-100">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-dark text-muted text-uppercase small">
                            <tr>
                                <th class="ps-4 py-3">Date</th>
                                <th>Type</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th class="text-end pe-4">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in transactions %}
                            <tr>
                                <td class="ps-4 text-white small">{{ t.date }}</td>
                                <td>
                                    {% if t.type == 'OPEN BUY' or t.type == 'BUY' %}
                                        <span class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25" style="font-size: 0.65rem;">BUY</span>
                                    {% elif t.type == 'CLOSE SELL' or t.type == 'SELL' %}
                                        <span class="badge bg-danger bg-opacity-25 text-danger border border-danger border-opacity-25" style="font-size: 0.65rem;">SELL</span>
                                    {% else %}
                                        <span class="badge bg-secondary" style="font-size: 0.65rem;">{{ t.type }}</span>
                                    {% endif %}
                                </td>
                                <td class="fw-bold text-white small">{{ t.quantity }}</td>
                                <td class="text-muted small">{{ t.price_original }}</td>
                                <td class="fw-bold text-white text-end pe-4 small">{{ t.value_pln }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center py-4 text-muted">No transactions found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-6">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0 text-white fw-bold">Market News</h4>
            <span class="badge bg-secondary bg-opacity-25 text-muted">Auto-generated</span>
        </div>

        <div class="card border-secondary border-opacity-25 h-100">
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for n in news %}
                    <a href="{{ n.link }}" target="_blank" class="list-group-item list-group-item-action bg-transparent border-secondary border-opacity-25 py-3 px-4">
                        <div class="d-flex w-100 justify-content-between align-items-start mb-1">
                            <h6 class="mb-1 text-white fw-bold text-truncate-2" style="line-height: 1.4;">{{ n.title }}</h6>
                            <small class="{% if n.freshness == 0 %}text-success fw-bold{% elif n.freshness == 1 %}text-white{% else %}text-muted{% endif %} ms-2 text-nowrap" style="font-size: 0.7rem;">
                                {{ n.date_label }}
                            </small>
                        </div>
                        <div class="d-flex align-items-center mt-2">
                            <small class="text-muted me-2" style="font-size: 0.7rem;"><i class="fas fa-newspaper me-1"></i> {{ n.source }}</small>
                            {% for tag in n.tags %}
                                <span class="badge rounded-pill {% if tag == 'OFFICIAL' %}bg-info text-dark{% elif tag == 'MONEY' %}bg-success{% elif tag == 'RESULTS' %}bg-warning text-dark{% else %}bg-secondary{% endif %} me-1" style="font-size: 0.6rem;">
                                    {{ tag }}
                                </span>
                            {% endfor %}
                        </div>
                    </a>
                    {% empty %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-newspaper fa-3x mb-3 opacity-25"></i>
                        <p>No recent news found for this asset.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{# --- DATA ISLANDS --- #}
{{ chart_dates|json_script:"c-dates" }}
{{ chart_prices|json_script:"c-prices" }}
{{ chart_point_colors|json_script:"c-colors" }}
{{ chart_point_radius|json_script:"c-radius" }}
{{ first_trade_date|json_script:"first-trade-date" }}
{{ ath|json_script:"val-ath" }}
{{ atl|json_script:"val-atl" }}

<style>
    .text-truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; white-space: normal; }
    .btn-group .btn.active { background-color: var(--accent-green); color: #121212 !important; border-color: var(--accent-green); font-weight: bold; }
</style>

<script src="{% static 'js/charts_details.js' %}"></script>

{% endblock %}