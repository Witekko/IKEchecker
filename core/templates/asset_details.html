{% extends 'base.html' %}

{% block content %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <div class="d-flex align-items-center">
                <h2 class="fw-bold mb-0 text-white me-3">{{ asset.symbol }}</h2>
                <span class="badge bg-secondary bg-opacity-25 text-light border border-secondary border-opacity-25 rounded-pill px-3">
                    {{ asset.currency }}
                </span>
            </div>
            <p class="text-muted mb-0">{{ asset.name }}</p>
        </div>

        <div class="d-flex gap-5 text-end">
            <div>
                <div class="text-muted small text-uppercase mb-1">1D Change</div>
                <h3 class="fw-bold mb-0 {% if day_change_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if day_change_raw > 0 %}+{% endif %}{{ day_change_pln }} <small class="fs-6 opacity-50">PLN</small>
                </h3>
                <small class="{% if day_change_raw >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                     {% if day_change_raw > 0 %}+{% endif %}{{ day_change_pct }}%
                </small>
            </div>

            <div>
                <div class="text-muted small text-uppercase mb-1">Total P&L</div>
                <h3 class="fw-bold mb-0 {% if profit_pln_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if profit_pln_raw > 0 %}+{% endif %}{{ profit_pln }} <small class="fs-6 opacity-50">PLN</small>
                </h3>
                <small class="{% if profit_percent_raw >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                    {% if profit_percent_raw > 0 %}<i class="fas fa-caret-up"></i>{% else %}<i class="fas fa-caret-down"></i>{% endif %}
                    {{ profit_percent }}%
                </small>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-5">
        <div class="col-6 col-md-3">
            <div class="card h-100 shadow-sm border-secondary border-opacity-25">
                <div class="card-body py-3">
                    <div class="text-muted small fw-bold text-uppercase mb-1">Kurs (Live)</div>
                    <h4 class="mb-0 fw-bold text-white">{{ current_price }}</h4>
                    <small class="text-muted">{{ asset.currency }}</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 shadow-sm border-secondary border-opacity-25">
                <div class="card-body py-3">
                    <div class="text-muted small fw-bold text-uppercase mb-1">Posiadane</div>
                    <h4 class="mb-0 fw-bold text-white">{{ qty }}</h4>
                    <small class="text-muted">szt.</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 shadow-sm border-secondary border-opacity-25">
                <div class="card-body py-3">
                    <div class="text-muted small fw-bold text-uppercase mb-1">Åšr. Cena Zakupu</div>
                    <h4 class="mb-0 fw-bold text-white">{{ avg_price }}</h4>
                    <small class="text-muted">PLN</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 shadow-sm border-secondary border-opacity-25 bg-dark">
                <div class="card-body py-3 text-end">
                    <div class="text-muted small fw-bold text-uppercase mb-1">WartoÅ›Ä‡</div>
                    <h4 class="mb-0 fw-bold text-white">{{ value_pln }}</h4>
                    <small class="text-muted">PLN</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-5 border-secondary border-opacity-25">
        <div class="card-header border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
            <span class="text-muted text-uppercase fw-bold ls-1">Analiza Techniczna</span>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary active" onclick="updateChartRange('1M', this)">1M</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="updateChartRange('3M', this)">3M</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="updateChartRange('6M', this)">6M</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="updateChartRange('1Y', this)">1Y</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="updateChartRange('ALL', this)">MAX</button>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container-wide">
                <canvas id="assetChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5 order-lg-2">
            <div class="d-flex align-items-center mb-3">
                <span class="fs-5 me-2">ðŸ“°</span> <h5 class="mb-0 fw-bold text-muted text-uppercase ls-1">News Feed</h5>
            </div>
            <div class="d-flex flex-column gap-3">
                {% for news in news_list %}
                <a href="{{ news.link }}" target="_blank" class="text-decoration-none">
                    <div class="card h-100 shadow-sm border-secondary border-opacity-10 bg-transparent hover-card">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <small class="text-muted" style="font-size: 0.7rem;">{{ news.source }} â€¢ {{ news.date_label }}</small>
                                <div>
                                    {% if news.freshness == 0 %}<span class="badge bg-danger text-white" style="font-size: 0.6rem;">HOT</span>{% endif %}
                                    {% for tag in news.tags %}
                                        {% if tag == 'OFFICIAL' %}<span class="badge bg-primary bg-opacity-25 text-primary border border-primary border-opacity-25" style="font-size: 0.6rem;">ESPI</span>{% endif %}
                                        {% if tag == 'MONEY' %}<span class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25" style="font-size: 0.6rem;">$$$</span>{% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <h6 class="mb-0 text-white fw-normal" style="font-size: 0.9rem; line-height: 1.4;">{{ news.title }}</h6>
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="text-muted text-center py-4 small">Brak newsÃ³w dla tej spÃ³Å‚ki.</div>
                {% endfor %}
            </div>
        </div>

        <div class="col-lg-7 order-lg-1">
            <div class="d-flex align-items-center mb-3">
                <span class="fs-5 me-2">ðŸ“œ</span> <h5 class="mb-0 fw-bold text-muted text-uppercase ls-1">Historia Transakcji</h5>
            </div>
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-dark">
                            <tr class="text-muted small text-uppercase">
                                <th class="ps-4 py-3">Data</th><th>Typ</th><th>IloÅ›Ä‡</th><th>Kwota</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in history %}
                            <tr>
                                <td class="ps-4 text-white font-monospace small">{{ t.date|date:"Y-m-d" }}</td>
                                <td>
                                    {% if t.type == 'Kupno' or t.type == 'BUY' %}
                                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">KUPNO</span>
                                    {% elif t.type == 'SprzedaÅ¼' or t.type == 'SELL' %}
                                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">SPRZEDAÅ»</span>
                                    {% else %}
                                        <span class="badge bg-secondary text-dark">{{ t.type }}</span>
                                    {% endif %}
                                </td>
                                <td class="fw-bold text-white">{{ t.quantity }}</td>
                                <td class="text-muted">{{ t.amount }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-4 text-muted">Brak transakcji</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {{ chart_dates|json_script:"c-dates" }}
    {{ chart_prices|json_script:"c-prices" }}
    {{ chart_colors|json_script:"c-colors" }}
    {{ chart_radius|json_script:"c-radius" }}

    <style>
        .ls-1 { letter-spacing: 1px; }
        .hover-card { transition: transform 0.2s, background-color 0.2s; }
        .hover-card:hover { transform: translateY(-2px); background-color: rgba(255,255,255,0.05) !important; }
    </style>

    <script>
        function gd(id) { return JSON.parse(document.getElementById(id).textContent); }

        const ctx = document.getElementById('assetChart');
        const allPrices = gd('c-prices');
        const allDates = gd('c-dates');
        const allColors = gd('c-colors');
        const allRadius = gd('c-radius');

        let myChart = null;

        function initChart(dates, prices, colors, radius) {
            // 1. Obliczamy ATH i ATL dla wybranego okresu
            const maxVal = Math.max(...prices);
            const minVal = Math.min(...prices);
            const startVal = prices[0];
            const endVal = prices[prices.length - 1];

            // 2. Kolory gÅ‚Ã³wnej linii
            const isGreen = endVal >= startVal;
            const lineColor = isGreen ? '#98FB98' : '#ef5350';
            const areaColor = isGreen ? 'rgba(152, 251, 152, 0.1)' : 'rgba(239, 83, 80, 0.1)';

            // 3. Tworzymy serie danych dla linii poziomych (muszÄ… mieÄ‡ tyle samo punktÃ³w co wykres)
            const athData = Array(dates.length).fill(maxVal);
            const atlData = Array(dates.length).fill(minVal);
            const startLineData = Array(dates.length).fill(startVal);

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Cena',
                            data: prices,
                            borderColor: lineColor,
                            backgroundColor: areaColor,
                            borderWidth: 2,
                            fill: true,
                            pointBackgroundColor: colors,
                            pointBorderColor: '#fff',
                            pointRadius: radius,
                            pointHoverRadius: 8,
                            tension: 0.2,
                            order: 1
                        },
                        {
                            label: 'ATH (Szczyt)',
                            data: athData,
                            borderColor: 'rgba(152, 251, 152, 0.6)', // PÃ³Å‚przezroczysty zielony
                            borderWidth: 1,
                            borderDash: [5, 5], // Linia przerywana
                            pointRadius: 0,
                            fill: false,
                            order: 2
                        },
                        {
                            label: 'ATL (DoÅ‚ek)',
                            data: atlData,
                            borderColor: 'rgba(239, 83, 80, 0.6)', // PÃ³Å‚przezroczysty czerwony
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            order: 3
                        },
                        {
                            label: 'Start',
                            data: startLineData,
                            borderColor: 'rgba(255, 255, 255, 0.3)', // Szary
                            borderWidth: 1,
                            borderDash: [2, 4],
                            pointRadius: 0,
                            fill: false,
                            order: 4
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#888', maxTicksLimit: 8 } },
                        y: { grid: { color: '#333', borderDash: [4, 4] }, ticks: { color: '#888' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index', intersect: false,
                            callbacks: { label: function(c) { return c.dataset.label + ': ' + c.parsed.y + ' {{ asset.currency }}'; } }
                        }
                    }
                }
            });
        }

        function updateChartRange(range, btnElement) {
            document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            if (range === 'ALL') {
                initChart(allDates, allPrices, allColors, allRadius);
                return;
            }

            const now = new Date();
            let cutoffDate = new Date();

            if (range === '1M') cutoffDate.setMonth(now.getMonth() - 1);
            if (range === '3M') cutoffDate.setMonth(now.getMonth() - 3);
            if (range === '6M') cutoffDate.setMonth(now.getMonth() - 6);
            if (range === '1Y') cutoffDate.setFullYear(now.getFullYear() - 1);

            let filteredDates = [], filteredPrices = [], filteredColors = [], filteredRadius = [];

            for (let i = 0; i < allDates.length; i++) {
                let d = new Date(allDates[i]);
                if (d >= cutoffDate) {
                    filteredDates.push(allDates[i]);
                    filteredPrices.push(allPrices[i]);
                    filteredColors.push(allColors[i]);
                    filteredRadius.push(allRadius[i]);
                }
            }
            initChart(filteredDates, filteredPrices, filteredColors, filteredRadius);
        }

        updateChartRange('1M', document.querySelector('.btn-group .btn'));
    </script>

{% endblock %}