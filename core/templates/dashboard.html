{% extends 'base.html' %}

{% block content %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1 text-white">Market Dashboard</h2>
            <p class="text-muted mb-0">Command Center. All values in PLN.</p>
        </div>

        <div class="d-flex align-items-center gap-4">

            <div class="d-none d-md-flex align-items-center gap-3 text-muted small border-end border-secondary border-opacity-25 pe-4">
                <div class="d-flex flex-column align-items-end" style="line-height: 1.1;">
                    <span class="fw-bold text-white">USD</span>
                    <span>{{ rates.USD }}</span>
                </div>
                <div class="d-flex flex-column align-items-end" style="line-height: 1.1;">
                    <span class="fw-bold text-white">EUR</span>
                    <span>{{ rates.EUR }}</span>
                </div>
                <div class="d-flex flex-column align-items-end" style="line-height: 1.1;">
                    <span class="fw-bold text-white">GBP</span>
                    <span>{{ rates.GBP }}</span>
                </div>
                <div class="d-flex flex-column align-items-end" style="line-height: 1.1;">
                    <span class="fw-bold text-white">AUD</span>
                    <span>{{ rates.AUD }}</span>
                </div>
                <div class="d-flex flex-column align-items-end" style="line-height: 1.1;">
                    <span class="fw-bold text-white">JPY</span>
                    <span style="font-size: 0.75rem;">(100) {{ rates.JPY }}</span>
                </div>
            </div>

            <div>
                <span class="badge bg-dark border border-success text-success px-3 py-2 rounded-pill"
                      style="color: var(--accent-green) !important; border-color: var(--accent-green) !important;">
                    <i class="fas fa-circle me-2 animate-pulse" style="font-size: 0.6rem;"></i>LIVE
                </span>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">

        <div class="col-md-4 col-xl-3">
            <div class="card h-100 shadow-sm border-secondary border-opacity-25">
                <div class="card-body py-3 d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-muted small fw-bold text-uppercase mb-1">Total Value</div>
                        <h3 class="mb-0 fw-bold text-white">{{ tile_value_str }} <small class="fs-6 text-muted">PLN</small></h3>
                    </div>
                    <i class="fas fa-wallet fa-2x text-muted opacity-10"></i>
                </div>
            </div>
        </div>

        <div class="col-md-4 col-xl-3">
            <div class="card h-100 shadow-sm border-secondary border-opacity-25">
                <div class="card-body py-3">
                    <div class="text-muted small fw-bold text-uppercase mb-1">Total Profit</div>
                    <div class="d-flex align-items-baseline">
                        <h4 class="mb-0 me-2 fw-bold {% if tile_total_profit_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if tile_total_profit_raw > 0 %}<i class="fas fa-arrow-up me-1"></i>+{% else %}<i class="fas fa-arrow-down me-1"></i>{% endif %}
                            {{ tile_total_profit_str }}
                        </h4>
                        <span class="small text-muted">PLN</span>
                    </div>
                </div>
            </div>
        </div>

         <div class="col-md-2 col-xl-2">
            <div class="card h-100 shadow-sm border-secondary border-opacity-25">
                <div class="card-body py-3 text-center">
                    <div class="text-muted small fw-bold text-uppercase mb-1">Total Return</div>
                    <h4 class="mb-0 fw-bold {% if tile_return_pct_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                         {% if tile_return_pct_raw > 0 %}+{% endif %}{{ tile_return_pct_str }}%
                    </h4>
                </div>
            </div>
        </div>

        <div class="col-md-2 col-xl-2">
            <div class="card h-100 shadow-sm border-secondary border-opacity-25">
                <div class="card-body py-3 text-center">
                    <div class="text-muted small fw-bold text-uppercase mb-1">Avg. Annual</div>
                    <h4 class="mb-0 fw-bold {% if tile_annual_pct_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ tile_annual_pct_str }}%
                    </h4>
                </div>
            </div>
        </div>

         <div class="col-md-12 col-xl-2">
            <div class="card h-100 shadow-sm border-secondary border-opacity-25 bg-dark">
                <div class="card-body py-3 text-end">
                    <div class="text-muted small fw-bold text-uppercase">Unrealized</div>
                    <div class="fw-bold fs-5 {% if tile_current_profit_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                         {{ tile_current_profit_str }} PLN
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-5">

        <div class="col-md-3">
            <div class="card h-100 border-secondary border-opacity-10 bg-transparent">
                <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                    <span class="text-muted small text-uppercase">1D Change</span>
                    <span class="fw-bold fs-5 {% if tile_day_pct_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if tile_day_pct_raw > 0 %}<i class="fas fa-caret-up me-1"></i>{% else %}<i class="fas fa-caret-down me-1"></i>{% endif %}
                        {{ tile_day_pct_str }}%
                    </span>
                </div>
            </div>
        </div>

        <div class="col-md-3">
             <div class="card h-100 border-secondary border-opacity-10 bg-transparent">
                <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                    <span class="text-muted small text-uppercase">1D Gain</span>
                    <span class="fw-bold fs-5 {% if tile_day_pln_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ tile_day_pln_str }}
                    </span>
                </div>
            </div>
        </div>

        <div class="col-md-3">
             <div class="card h-100 border-secondary border-opacity-10 bg-transparent">
                <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                    <span class="text-muted small text-uppercase"><i class="fas fa-arrow-up text-success me-1"></i>Gainers</span>
                    <span class="fw-bold fs-5 text-white">{{ tile_gainers }}</span>
                </div>
            </div>
        </div>

        <div class="col-md-3">
             <div class="card h-100 border-secondary border-opacity-10 bg-transparent">
                <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                    <span class="text-muted small text-uppercase"><i class="fas fa-arrow-down text-danger me-1"></i>Losers</span>
                    <span class="fw-bold fs-5 text-white">{{ tile_losers }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-5">
        <div class="card-header d-flex justify-content-between align-items-center border-0 pb-0 pt-4 px-4">
            <span class="text-muted text-uppercase fw-bold ls-1">Portfolio History</span>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-dark text-muted active rounded-start-pill px-3" id="btn-val" onclick="switchChart('value')">PLN</button>
                <button type="button" class="btn btn-sm btn-dark text-muted rounded-end-pill px-3" id="btn-pct" onclick="switchChart('percent')">%</button>
            </div>
        </div>
        <div class="card-body pt-2 px-3">
            <div class="chart-container-wide">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row mb-5 g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header border-0 pt-4 px-4 text-muted text-uppercase fw-bold ls-1">Asset Allocation</div>
                <div class="card-body"><div class="chart-container"><canvas id="allocationChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header border-0 pt-4 px-4 text-muted text-uppercase fw-bold ls-1">Profit by Asset</div>
                <div class="card-body"><div class="chart-container"><canvas id="profitChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="d-flex align-items-center mb-3 mt-5">
        <span class="fs-4 me-2">üáµüá±</span> <h4 class="mb-0 fw-bold">Poland (GPW)</h4>
    </div>
    <div class="card mb-4 border-0 shadow-sm"><div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-dark"><tr><th class="ps-4 py-3">Symbol</th><th>Qty</th><th>Avg Price</th><th>Price</th><th>1D %</th><th>Value</th><th>Profit/Loss</th></tr></thead>
            <tbody>
                {% for item in pln_holdings %}
                <tr>
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3 border border-secondary" style="width: 40px; height: 40px; color: #fff;">{{ item.symbol|slice:":1" }}</div>
                            <div><a href="/asset/{{ item.symbol }}/" class="text-white fw-bold">{{ item.symbol }}</a><br><small class="text-muted">{{ item.name }}</small></div>
                        </div>
                    </td>
                    <td class="fw-bold">{{ item.quantity }}</td><td>{{ item.avg_price_pln }}</td><td>{{ item.current_price_orig }}</td>
                    <td class="fw-bold {% if item.day_change_pct_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if item.day_change_pct_raw > 0 %}+{% endif %}{{ item.day_change_pct }}%
                    </td>
                    <td class="fw-bold fs-5">{{ item.value_pln }}</td>
                    <td class="{% if item.gain_pln_raw >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                        {{ item.gain_pln }}<br><small class="opacity-50">({{ item.gain_percent }}%)</small>
                    </td>
                </tr>
                {% empty %}<tr><td colspan="7" class="text-center py-4 text-muted">No positions</td></tr>{% endfor %}
            </tbody>
            <tfoot class="bg-dark border-top border-secondary">
                <tr class="fw-bold fs-5">
                    <td colspan="5" class="text-end pe-4 text-uppercase text-muted small py-3">Total GPW:</td>
                    <td class="py-3 text-white">{{ totals_pln.value }}</td>
                    <td class="py-3 {% if totals_pln.gain_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ totals_pln.gain }}
                    </td>
                </tr>
            </tfoot>
        </table>
    </div></div>

    <div class="d-flex align-items-center mb-3 mt-5">
        <span class="fs-4 me-2">üåç</span> <h4 class="mb-0 fw-bold">Global (ETF/Stocks)</h4>
    </div>
    <div class="card mb-5 border-0 shadow-sm"><div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-dark"><tr><th class="ps-4 py-3">Symbol</th><th>Qty</th><th>Avg Price (PLN)</th><th>Price (Orig)</th><th>1D %</th><th>Value (PLN)</th><th>Profit/Loss</th></tr></thead>
            <tbody>
                {% for item in foreign_holdings %}
                <tr>
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3 border border-secondary" style="width: 40px; height: 40px; color: #fff;">{{ item.symbol|slice:":1" }}</div>
                            <div><a href="/asset/{{ item.symbol }}/" class="text-white fw-bold">{{ item.symbol }}</a><br><small class="text-muted">{{ item.name }}</small></div>
                        </div>
                    </td>
                    <td class="fw-bold">{{ item.quantity }}</td><td>{{ item.avg_price_pln }}</td><td>{{ item.current_price_orig }} {{ item.currency }}</td>
                    <td class="fw-bold {% if item.day_change_pct_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if item.day_change_pct_raw > 0 %}+{% endif %}{{ item.day_change_pct }}%
                    </td>
                    <td class="fw-bold fs-5">{{ item.value_pln }}</td>
                    <td class="{% if item.gain_pln_raw >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                        {{ item.gain_pln }}<br><small class="opacity-50">({{ item.gain_percent }}%)</small>
                    </td>
                </tr>
                {% empty %}<tr><td colspan="7" class="text-center py-4 text-muted">No positions</td></tr>{% endfor %}
            </tbody>
            <tfoot class="bg-dark border-top border-secondary">
                <tr class="fw-bold fs-5">
                    <td colspan="5" class="text-end pe-4 text-uppercase text-muted small py-3">Total Global:</td>
                    <td class="py-3 text-white">{{ totals_foreign.value }}</td>
                    <td class="py-3 {% if totals_foreign.gain_raw >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ totals_foreign.gain }}
                    </td>
                </tr>
            </tfoot>
        </table>
    </div></div>

    {% if closed_holdings %}
    <h4 class="mt-5 mb-3 text-muted text-uppercase fw-bold ls-1">History (Closed Positions)</h4>
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card shadow h-100 border-secondary border-opacity-25">
                <div class="card-body p-0">
                    <table class="table table-sm text-muted mb-0">
                        <thead><tr><th class="ps-4 py-2">Symbol</th><th>Realized P&L</th></tr></thead>
                        <tbody>
                            {% for item in closed_holdings %}
                            <tr>
                                <td class="ps-4">{{ item.symbol }}</td>
                                <td class="{% if item.gain_pln_raw >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                    {{ item.gain_pln }} PLN
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow h-100 border-secondary border-opacity-25">
                <div class="card-body"><div class="chart-container"><canvas id="closedChart"></canvas></div></div>
            </div>
        </div>
    </div>
    {% endif %}

    {{ chart_labels|json_script:"l-alloc" }} {{ chart_allocation|json_script:"d-alloc" }}
    {{ chart_profit_labels|json_script:"l-prof" }} {{ chart_profit_values|json_script:"d-prof" }}
    {{ closed_labels|json_script:"l-closed" }} {{ closed_values|json_script:"d-closed" }}
    {{ timeline_dates|json_script:"t-dates" }}
    {{ timeline_total_value|json_script:"t-user" }}
    {{ timeline_invested|json_script:"t-inv" }}
    {{ timeline_deposit_points|json_script:"t-points" }}
    {{ timeline_pct_user|json_script:"p-user" }}
    {{ timeline_pct_wig|json_script:"p-wig" }}
    {{ timeline_pct_sp500|json_script:"p-sp500" }}
    {{ timeline_pct_inflation|json_script:"p-inf" }}

    <style>.ls-1 { letter-spacing: 1px; }</style>

    <script>
        function gd(i){try{return JSON.parse(document.getElementById(i).textContent);}catch(e){return[];}}
        const NEW_GREEN = '#98FB98';
        const SOFT_RED = '#ef5350';
        const SOFT_BLUE = '#42a5f5';
        let mainChartInstance = null;
        const chartData = {
            dates: gd('t-dates'),
            value: { label: 'PLN', user: gd('t-user'), inv: gd('t-inv'), points: gd('t-points') },
            percent: { label: '%', user: gd('p-user'), wig: gd('p-wig'), sp500: gd('p-sp500'), inf: gd('p-inf') }
        };

        function renderMainChart(mode) {
            const ctx = document.getElementById('timelineChart');
            if (mainChartInstance) mainChartInstance.destroy();
            let datasets = [];
            const d = chartData[mode];
            const colorUser = SOFT_BLUE;
            const colorUserFill = 'rgba(66, 165, 245, 0.1)';
            const colorInv = '#6c757d';
            const colorWig = '#ffca28';
            const colorSp = '#ab47bc';
            const colorInf = NEW_GREEN;

            if (mode === 'value') {
                datasets = [
                    { label: 'Portfolio Value', data: d.user, borderColor: colorUser, backgroundColor: colorUserFill, borderWidth: 3, fill: true, pointRadius: d.points, pointBackgroundColor: colorUser, tension: 0.3 },
                    { label: 'Invested', data: d.inv, borderColor: colorInv, borderWidth: 2, borderDash:[4,4], pointRadius:0, tension: 0.3 }
                ];
            } else {
                datasets = [
                    { label: 'My Return (%)', data: d.user, borderColor: colorUser, backgroundColor: colorUserFill, borderWidth: 3, fill: true, pointRadius: 0, tension: 0.3 },
                    { label: 'WIG (%)', data: d.wig, borderColor: colorWig, borderWidth: 2, pointRadius:0, fill:false, tension: 0.3 },
                    { label: 'S&P 500 (%)', data: d.sp500, borderColor: colorSp, borderWidth: 2, pointRadius:0, fill:false, tension: 0.3 },
                    { label: 'Goal (6%)', data: d.inf, borderColor: colorInf, borderWidth: 2, borderDash:[2,2], pointRadius:0, fill:false, tension: 0.3 },
                    { label: 'Zero', data: Array(d.user.length).fill(0), borderColor: '#444', borderWidth:1, pointRadius:0 }
                ];
            }

            mainChartInstance = new Chart(ctx, {
                type: 'line', data: { labels: chartData.dates, datasets: datasets },
                options: {
                    responsive:true, maintainAspectRatio:false, interaction: { mode: 'index', intersect: false },
                    scales:{ x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }, y: { grid: { color: '#333', borderDash: [4, 4] }, ticks: { color: '#a0a0a0', callback: function(value) { return value + (mode === 'percent' ? '%' : ' PLN'); } } } },
                    plugins:{ legend: { labels: { color: '#e0e0e0', usePointStyle: true, boxWidth: 10 } }, tooltip: { backgroundColor: 'rgba(30,30,30,0.95)', titleColor: '#fff', bodyColor: '#ccc', borderColor: '#444', borderWidth: 1, cornerRadius: 8, padding: 10 } }
                }
            });
        }

        function switchChart(mode) {
            const btnVal = document.getElementById('btn-val'); const btnPct = document.getElementById('btn-pct');
            btnVal.className = 'btn btn-sm btn-dark text-muted rounded-start-pill px-3';
            btnPct.className = 'btn btn-sm btn-dark text-muted rounded-end-pill px-3';
            if (mode === 'value') { btnVal.classList.add('active', 'bg-primary', 'text-white'); btnVal.classList.remove('text-muted'); }
            else { btnPct.classList.add('active', 'bg-primary', 'text-white'); btnPct.classList.remove('text-muted'); }
            renderMainChart(mode);
        }
        if(chartData.dates.length > 0) renderMainChart('value');

        const pieColors = [SOFT_BLUE, '#ab47bc', SOFT_RED, '#ffa726', '#ffca28', NEW_GREEN, '#5c6bc0', '#bdbdbd'];
        const lAl = gd('l-alloc'); const dAl = gd('d-alloc');
        if(lAl.length > 0) {
            const totalPortfolio = dAl.reduce((a, b) => a + b, 0);
            const labelsWithPercent = lAl.map((label, index) => {
                const value = dAl[index]; const percent = totalPortfolio > 0 ? ((value / totalPortfolio) * 100).toFixed(1) : 0;
                return `${label} (${percent}%)`;
            });
            new Chart(document.getElementById('allocationChart'), { type:'doughnut', data:{ labels: labelsWithPercent, datasets:[{ data: dAl, backgroundColor: pieColors, borderWidth: 0, hoverOffset: 10 }] }, options:{ maintainAspectRatio:false, cutout: '70%', plugins: { legend: { position: 'right', labels: { color: '#e0e0e0', usePointStyle: true } } } } });
        }

        const barOptions = { maintainAspectRatio:false, scales: { x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }, y: { grid: { color: '#333' }, ticks: { color: '#a0a0a0' } } }, plugins: { legend: { display: false } } };
        const lPr = gd('l-prof'); if(lPr.length>0) new Chart(document.getElementById('profitChart'), { type:'bar', data:{labels:lPr,datasets:[{label:'Gain/Loss',data:gd('d-prof'),backgroundColor:gd('d-prof').map(v=>v>=0? NEW_GREEN : SOFT_RED), borderRadius: 6}]}, options: barOptions });
        const lCl = gd('l-closed'); if(lCl.length>0) new Chart(document.getElementById('closedChart'), { type:'bar', data:{labels:lCl,datasets:[{label:'Realized',data:gd('d-closed'),backgroundColor:gd('d-closed').map(v=>v>=0? NEW_GREEN : SOFT_RED), borderRadius: 6}]}, options: barOptions });
    </script>
{% endblock %}